@page "/editsttrns/{kind:int}"
@*@page "/editsstrns/{kind:int}/{id:int}"*@
@inject IDbContextFactory<nrcwebContext> dbf;
@inject DialogService ds
@inject NotificationService ns

<style>
    table > thead > tr {
        position: sticky;
        top: 0;
        z-index: 2;
        background: white;
    }
    
    label, tr, td {
        max-height: 25px;
    }
</style>

<div class="card border-secondary" style="width:99% !important;">

    <div class="card-header alert alert-primary h3 text-center m-1 p-1 ">
        @_hadd.StockCode
        @_hadd.Kind
        @_hadd.TrnNo
        @(_hadd.Kind == 1 ? "إذن إضافة" : "إذن صرف") - @(_hadd.Id == 0 ? "جديد" : "تعديل")
    </div>
    <div class="card-body">
        <RadzenTemplateForm TItem="Hadd" Data=@_hadd InvalidSubmit=@OnInvalidSubmit>

            <div class="form-group row  p-0 m-1" >
                <Label class="btn-outline-primary col-sm-2" @onclick="@(async ()=>await f_ondblclick("stockcode"))">كود المخزن ...</Label>
                <span>
                    <RadzenMask Mask=@stockcode_mask Pattern="[^0-9]" style="display: block ; background-color:lemonchiffon" Name="StockCode"
                                @bind-Value=@_hadd.StockCode Change=@(args => f_onchange( "stockcode",args))
                                @ondblclick="@(async ()=>await f_ondblclick("stockcode"))" />
                    <RadzenRequiredValidator Component="StockCode" Text="يجب إدخال كود المخزن" Style="position: absolute" />
                    <RadzenRegexValidator Component="StockCode" Text="كود المخزن رقمين" Pattern="\d{2}" Style="position: absolute" />
                </span>

            </div>

            <div class="form-group  row  p-0 m-1">
                <Label class="btn-outline-primary col-sm-2" @onclick="@(async ()=>await f_ondblclick("trnno"))">رقم المستند ...</Label>
                <span>
                    <RadzenMask Mask=@trn_no_mask Pattern="[^0-9]" style="display: block ; background-color:lemonchiffon" Name="trn_no"
                                @bind-Value=@_hadd.TrnNo Change=@(args => f_onchange( "trnno",args))
                                @ondblclick="@(async ()=>await f_ondblclick("trnno"))" />
                    <RadzenRequiredValidator Component="trn_no" Text="يجب إدخال رقم المستند" Style="position: absolute" />
                    <RadzenRegexValidator Component="trn_no" Text="رقم المستند 10 أرقام" Pattern="\d{10}" Style="position: absolute" />
                </span>

            </div>


            <div class="form-group row p-0 m-1">
                <RadzenLabel Text="تاريخ المستند" class="col-sm-2" />
                <RadzenDatePicker Name="trn_date" TValue=DateTime ShowTime="true" Value=_hadd.TrnDate HourFormat="12"
                                  DateFormat="dd/MM/yyyy hh:mm:ss tt" Change=@(args=>f_onchange("trn_date",args )) />
                <RadzenRegexValidator Component="trn_date" Text="يجب إدخال التاريخ بشكل سليم" Pattern="dd/MM/yyyy hh:mm:ss tt" Style="position: absolute" />

            </div>

            <div class="form-group row p-0 m-1">
                <label for="ghaname" class="col-sm-2">كود الجهة الطالبة</label>
                <RadzenTextBox style="display: block" Name="ghaname" @bind-Value=@_hadd.GhaName Change=@(args => f_onchange("ghaname",args )) />
            </div>

            <div class="form-group row p-0 m-1">
                <RadzenLabel Text="إسم الجهة" class="col-sm-2" />
                <div class="col-sm-10">
                    <div class="row">
                        <RadzenTextBox class="col-sm-8" style="display: block" Name="GhaMain" @bind-Value=@_hadd.GhaMain Change=@(args => f_onchange( "GhaMain",args)) />
                    </div>
                    <div class="row">
                        <RadzenRequiredValidator Component="GhaMain" Text="يجب إدخال وصف المخزن" />
                    </div>
                </div>



            </div>





        </RadzenTemplateForm>
        
            <div style=" height:250px ;font-size:small; overflow: auto; ">
                <table class="table table-responsive table-hover table-bordered  table-sm   d-none d-md-block">
                    <thead class="font-weight-bold text-center alert-primary">
                        <tr style="padding:0;margin:0;max-height:fit-content;"><td>م</td><th style="padding:0;margin:0;" > كود الصنف</th> <th style="padding:0;margin:0 ;"> إسم الصنف</th>  <th style="padding:0;margin:0" >الوحدة</th><th style="padding:0;margin:0" >الكمية</th> <th style="padding:0;margin:0" > السعر</th> <th > حذف</th> </tr>
                    </thead>
                    <tbody>
                        @{int r = 0; }
                        @foreach (var item in _hadd.Dadds)
                        {
                            <tr style="padding:0;margin:0;max-height:fit-content; background-color:lightsteelblue">
                                <td>@(r+1) </td>
                                <td style="padding: 0; margin: 0;"> <RadzenTextBox Style=" background-color: lemonchiffon;" class="form-control-sm" @ondblclick="@(async ()=>await f_ondblclickdetail("itemcode", _hadd.Dadds.ToList().IndexOf(item)))" Name=itemcode form="itemcode" @bind-Value="@item.ItemCode" Change=@(args => f_onchangedetail( "itemcode",args, _hadd.Dadds.ToList().IndexOf(item))) /></td>
                                <td style="padding:0;margin:0 ; " class="col-sm-5"><strong>@item.EngName</strong></td>
                                <td style="padding: 0; margin: 0;">  <RadzenTextBox Style="width: inherit !important; height: inherit !important;" form="unitname" class="form-control-sm" @bind-Value="@item.UnitName" /></td>
                                <td style="padding:0;margin:0"> <RadzenNumeric TValue="double?" ShowUpDown="false" Format="0.00" Style="margin:0px ;padding:0px;" form="itemquant" class="form-control-sm" @bind-Value="@item.ItemQuant" /></td>
                                <td style="padding:0;margin:0"> <RadzenNumeric TValue="double?" ShowUpDown="false" Format="0.00" Style="margin:0px ;padding:0px;" form="itemprice" class="form-control-sm" @bind-Value="@item.ItemPrice" /></td>
                                <td style="padding:0;margin:0 ;text-align:center "> <button tabindex=-1 style="width: inherit;" class="btn btn-primary btn-sm" @onclick="()=> { _hadd.Dadds.Remove(item); } ">&times;</button></td>
                            </tr>
                            r++;
                        }
                    </tbody>
                </table>

                <div class="d-block d-md-none">
                    <ul>
                        @{ int k = 0; }
                        @foreach (var item in _hadd.Dadds)
                        {
                            <li>
                                @(k+1)
                                <Label class="btn-outline-primary col-sm-2" @ondblclick="@(async ()=>await f_ondblclickdetail("itemcode",_hadd.Dadds.ToList().IndexOf(item)))">كود الصنف</Label>
                                <span>
                                    <RadzenMask Mask=@itemmask Pattern="[^0-9]" style="display: block ; background-color:lemonchiffon" Name="itemcode"
                                                @bind-Value=item.ItemCode Change=@(args => f_onchangedetail( "itemcode",args,_hadd.Dadds.ToList().IndexOf(item)))
                                                @ondblclick="@(async ()=>await f_ondblclickdetail("itemcode",_hadd.Dadds.ToList().IndexOf(item)))" />
                                    <RadzenRequiredValidator Component="itemcode" Text="يجب إدخال كود الصنف" Style="position: absolute" />
                                    <RadzenRegexValidator Component="itemcode" Text="كود الصنف 5 أرقام" Pattern="\d{5}" Style="position: absolute" />

                                </span>
                                <span>@item.EngName</span>
                                <Label class="btn-outline-primary col-sm-2" @onclick="@(async ()=>await f_ondblclick("itemcode"))">الوحدة</Label>
                                <RadzenTextBox Style="width: inherit !important; height: inherit !important;" form="unitname" class="form-control-sm" @bind-Value="@item.UnitName" />
                            </li>
                            k++;
                        }
                    </ul>
                </div>
            
        </div>


    </div>
    <div class="card-footer">

        @*<div class=" alert alert-info border border-info text-center h3">
            <button class="btn btn-primary btn  col-2 mr-auto font-weight-bolder" @onclick="onSave">تسجيل</button>
            <button class="btn btn-primary btn col-2 mr-auto font-weight-bolder" @onclick="onNew">إضافة</button>
            <button class="btn btn-danger btn col-2 mr-auto font-weight-bolder" @onclick="onDelete">حذف</button>
        </div>*@
        <div class=" alert alert-info border border-info text-center btn-group-sm  m-2 p-2">
                <button class="btn btn-primary btn-s  col-2 mr-auto font-weight-bolder" ButtonType="ButtonType.Submit" ButtonStyle="ButtonStyle.Secondary" @onclick="onSave">تسجيل</button>
                 <button class="btn btn-primary  col-2 mr-auto font-weight-bolder" @onclick="onAddNewItem">إضافة صنف</button>
                 <button class="btn btn-primary  col-2 mr-auto font-weight-bolder" @onclick="onNew">جديد</button>
                <button class="btn btn-danger col-2 mr-auto font-weight-bolder"  @onclick="onDelete">حذف</button>
            
        </div>
    </div>




</div>

@code {
    #region code
    [Parameter]
    public int? id { get; set; }
    [Parameter]
    public int kind { get; set; }
    private Hadd _hadd = new Hadd();
    private string stockcode_mask = "**";
    private string trn_no_mask = "**********";
    private string itemmask = "*****";
    private string old_stockcode;
    protected override void OnInitialized()
    {
        if (id != null) using (var db = dbf.CreateDbContext()) _hadd = db.Hadds.Where(r => r.Id == id).FirstOrDefault();
        else onNew();

    }
    private async Task<int> onSave()
    {
        if (!on_presave()) return -1;
        try
        {
            using (var db = dbf.CreateDbContext())
            {
                if (_hadd.Id == 0)
                    await db.AddAsync(_hadd);
                else
                    db.Update(_hadd);
                await db.SaveChangesAsync();
            }
        }
        catch (Exception)
        {
            throw;
        }
        return 0;

    }
    private bool on_presave()
    {
        return true;
    }
    private void onDelete()
    {
        try
        {
            using (var db = dbf.CreateDbContext())
                if (_hadd.Id != 0)
                {
                    db.Remove(_hadd);
                    if (db.SaveChanges() > 0) onNew();
                }

        }
        catch (DbUpdateException e)
        {

            throw e;
        }
    }
    private void onNew()
    {


        _hadd = new Hadd();
        _hadd.Kind = (byte)kind;
        _hadd.StockCode = old_stockcode;
        if (!string.IsNullOrEmpty(old_stockcode))
        {
            _hadd.StockCode = old_stockcode;
            int maxno;
            using (var db = dbf.CreateDbContext())
            {
                int.TryParse(db.Hadds.Where(a => a.StockCode == old_stockcode).OrderByDescending(a => a.TrnNo).FirstOrDefault().TrnNo, out maxno);
            }
            maxno++;
            _hadd.TrnNo = maxno.ToString();
        }

        _hadd.TrnDate = DateTime.Parse(DateTime.Now.ToString("dd/MM/yyyy hh:mm:ss tt"));
        //  DateTime.ParseExact(DateTime.Now.ToString("MM/dd/yyyy hh:mm tt"), "", CultureInfo.InvariantCulture);

    }

    public async Task f_onchange(string name, dynamic arg)
    {
        string _value = "";
        switch (name.ToLower())
        {
            case "stockcode":
                _hadd.StockCode = "";
                await Task.Delay(1); //Magic!
                StateHasChanged();
                _value = arg;
                _value = _value.Substring(0, Math.Min(2, _value.Length));
                _value = _value.PadLeft(2, '0');
                using (var db = dbf.CreateDbContext())
                {
                    Stock st;
                    st = db.Stocks.FirstOrDefault<Stock>(a => a.StockCode == _value);
                    if (st != null)
                    {
                        old_stockcode = _value;
                        onNew();
                        _hadd.StockCode = _value;

                    }
                }
                StateHasChanged();
                break;

            case "trnno":
                if (string.IsNullOrEmpty(_hadd.StockCode))
                {
                    await Task.Delay(1); //Magic!
                    StateHasChanged();
                    ns.Notify(new NotificationMessage() { Detail = "يجب إختيار المخزن أولاً" });
                    _hadd.TrnNo = "";
                    StateHasChanged();
                }
                else
                {
                    string _trnno = (string)arg;

                    await Task.Delay(1); //Magic!
                    StateHasChanged();

                    _trnno = _trnno.Substring(0, Math.Min(10, _trnno.Length));
                    _trnno = _trnno.PadLeft(10, '0');

                    using (var db = dbf.CreateDbContext())
                    {
                        _hadd = db.Hadds.Where(a => a.TrnNo == _trnno && a.StockCode == old_stockcode && a.Kind == kind).Include(a => a.Dadds).ToList().FirstOrDefault();
                        if (_hadd == null)
                        {
                            onNew();
                            _hadd.StockCode = old_stockcode;
                            _hadd.TrnNo = arg;
                        }
                    }

                }


                break;

            //case "stockname":
            //    _stock.StockName = "";
            //    await Task.Delay(1); //Magic!
            //    StateHasChanged();
            //    _value = arg;
            //    if (string.IsNullOrEmpty(_value.ToString()))
            //    {
            //        // _notifi.Notify((new NotificationMessage { Severity = NotificationSeverity.Error, Summary = "", Detail = "يجب إدخال الإسم", Duration = -1 }));
            //        //  gtool.Mynotify("خطأ", "يجب إدخال وصف المخزن");
            //    }
            //    _value = _value.Substring(0, Math.Min(50, _value.Length));
            //    _stock.StockName = _value;
            //    StateHasChanged();
            //    break;
            case "trn_date":
                DateTime dt;
                if (DateTime.TryParse(arg.ToString(), out dt)) { _hadd.TrnDate = dt; }
                break;
            default: break;
        }
    }
    private async Task f_ondblclick(string name)
    {
        Dictionary<string, object> ret;
        switch (name.ToLower())
        {
            case "stockcode":
                ret = await ds.OpenAsync<GModalList<Stock>>("",
            new Dictionary<string, object>() { { "title", "قائمة المخازن" }, { "scollist", "stockcode,stockname" }, { "colheads", "كود المخزن ,إسم المخزن" } },
            new DialogOptions() { ShowTitle = false, Width = "400px", Height = "400px", Resizable = true, Draggable = true });
                if (ret != null)
                {
                    if (!((bool)ret["status"])) return;
                    List<Stock> val = ret["result"] as List<Stock>;
                    _hadd.StockCode = val[0].StockCode;
                    await f_onchange("stockcode", val[0].StockCode);
                }
                break;

            case "trnno":
                List<Hadd> ll = new List<Hadd>();
                using (var db = dbf.CreateDbContext())
                {
                    ll = db.Hadds.Where(h => h.StockCode == _hadd.StockCode & h.Kind == kind).ToList();
                }
                ret = await ds.OpenAsync<GModalList<Hadd>>("",
        new Dictionary<string, object>() { { "scollist", "TrnNo,TrnDate" }, { "colheads", "رقم المستند,تاريخ المستند" }, { "data", ll } },
        new DialogOptions() { ShowTitle = false, Width = "400px", Height = "400px", Resizable = true, Draggable = true });
                if (ret != null)
                {
                    if (!((bool)ret["status"])) return;
                    List<Hadd> val = ret["result"] as List<Hadd>;
                    _hadd.TrnNo = val[0].TrnNo;
                    await f_onchange("trnno", _hadd.TrnNo);
                }
                break;
            default: break;
        }

    }

    public void onAddNewItem()
    {
        Dadd d = new Dadd();
        _hadd.Dadds.Add(d);

    }
    public async Task f_onchangedetail(string name, dynamic arg, int row)
    {
        string _value = "";
        switch (name.ToLower())
        {
            case "itemcode":
                _hadd.Dadds.ToList().ElementAt(row).ItemCode = "";
                await Task.Delay(1); //Magic!
                StateHasChanged();
                _value = arg;
                _value = _value.Substring(0, Math.Min(5, _value.Length));
                _value = _value.PadLeft(5, '0');
                Item item;
                using (var db = dbf.CreateDbContext()) item = db.Items.FirstOrDefault<Item>(a => a.ItemCode == _value && a.StockCode == old_stockcode);
                if (item != null) {
                    _hadd.Dadds.ToList().ElementAt(row).ItemCode = item.ItemCode;
                    _hadd.Dadds.ToList().ElementAt(row).EngName = item.EngName;
                    _hadd.Dadds.ToList().ElementAt(row).UnitName = item.UnitName;
                    _hadd.Dadds.ToList().ElementAt(row).ItemPrice =(double?) item.Value;

                }
                else
                {
                    _hadd.Dadds.ToList().ElementAt(row).ItemCode = "";
                    ns.Notify(new NotificationMessage() { Detail = "الصنف خطأ" });
                }
                StateHasChanged();
                //get units & prices
                break;
        }
    }
    private async Task f_ondblclickdetail(string name, int row)
    {
        Dictionary<string, object> ret;
        List<Item> itemlist;
        switch (name.ToLower())
        {
            case "itemcode":
                using (var db = dbf.CreateDbContext()) itemlist = db.Items.Where(i => i.StockCode == _hadd.StockCode).ToList();

                ret = await ds.OpenAsync<GModalList<Item>>("",new Dictionary<string, object>() { { "title", "قائمة الأصناف" }
                    , { "scollist", "itemcode,engname" },{ "colheads", "كود الصنف,إسم الصنف" }, { "data", itemlist } }
                    ,new DialogOptions() { ShowTitle = false, Width = "400px", Height = "400px", Resizable = true, Draggable = true });
                if (ret != null)
                {
                    if (!((bool)ret["status"])) return;
                    List<Item> val = ret["result"] as List<Item>;
                    _hadd.Dadds.ToList().ElementAt(row).ItemCode = val[0].ItemCode;
                    await f_onchangedetail("itemcode", val[0].ItemCode, row );
                }
                break;
            default: break;
        }
    }

    void OnSubmit(Hadd model)
    {
        Console.WriteLine(model);
    }
    void OnInvalidSubmit(FormInvalidSubmitEventArgs args)
    { }
    #endregion
}






